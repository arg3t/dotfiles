#!/bin/sh

# This is a small script to open a book from your calibre library
# Using dmenu.

USERNAME="yigitcolakoglu"
PASSWORD="$(pass show Server/calibre.yigitcolakoglu.com/yigitcolakoglu)"
HOST="https://calibre.fr1nge.xyz"

function urldecode() { : "${*//+/ }"; echo -e "${_//%/\\x}"; }

query=$(printf "" | dmenu -p "Please enter the book's name")
[ -z $query ] && exit

XML=$(curl -s -u "$USERNAME:$PASSWORD" "$HOST/opds/search?query=$query")

menu=$(echo $XML | xpath -q -e '//entry/title | //entry/author/name | //entry/link[@type="application/pdf"]/@href')

book=$(echo "$menu" | \
sed 's/<title>\(.*\)<\/title>/\1|/;N;s/<name>\(.*\)<\/name>/\1|/;N;s/href="\(.*\)"/\1/;s/\n/ /g' | \
column -s '|' -t | dmenu -p "Please select the book" -l 5)

[ -z "$book" ] && exit

name=$(echo "$book" | sed 's/\s\{2,\}/\n/g' | head -n 1)
author=$(echo "$book" | sed 's/\s\{2,\}/\n/g' | head -n 2 | tail -n 1)
path=$(echo "$book" | sed 's/\s\{2,\}/\n/g' | tail -n 1)

mkdir -p "$XDG_RUNTIME_DIR/books"
notify-send -a "ï€­ Downloading" "$(printf "%s\n%s" "$name" "$author")"

wget -nc -P "$XDG_RUNTIME_DIR/books" -q --content-disposition \
  --user "$USERNAME" --password "$PASSWORD" "$HOST$path" 

filename=$(curl -s  --head -u "$USERNAME:$PASSWORD" "$HOST$path" | \
  grep "Content-Disposition" |\
  sed -E 's/Content-Disposition:.*filename=([^;]*);.*/\1/g')

xdg-open "$XDG_RUNTIME_DIR/books/$(urldecode $filename)"
